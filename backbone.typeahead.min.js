(function(){var t,e={}.hasOwnProperty,n=function(t,n){function r(){this.constructor=t}for(var o in n)e.call(n,o)&&(t[o]=n[o]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t};Backbone.TypeaheadCollection=function(e){function r(){return t=r.__super__.constructor.apply(this,arguments)}return n(r,e),r.prototype._tokenize=function(t){return t=$.trim(t),0===t.length?null:t.toLowerCase().split(/[\s\-_]+/)},r.prototype._tokenizeModel=function(t){if(null==this.typeaheadAttributes)throw new Error("Missing typeaheadAttributes value");return _.uniq(this._tokenize(_.map(this.typeaheadAttributes,function(e){return t.get(e)}).join(" ")))},r.prototype._addToIndex=function(t){var e,n,r,o,i,u,s,a,h;for(_.isArray(t)&&t.slice(),h=[],s=0,a=t.length;a>s;s++)o=t[s],u=this._tokenizeModel(o),r=null!=o.id?o.id:o.cid,this._tokens[r]=u,h.push(function(){var t,o,s,a;for(a=[],o=0,s=u.length;s>o;o++)i=u[o],n=i.charAt(0),e=(t=this._adjacency)[n]||(t[n]=[r]),~_.indexOf(e,r)?a.push(void 0):a.push(e.push(r));return a}.call(this));return h},r.prototype._removeFromIndex=function(t){var e,n,r,o,i,u,s,a;for(_.isArray(t)&&t.slice(),n=_.pluck(t,"id"),i=0,u=n.length;u>i;i++)e=n[i],delete this._tokens[e];s=this._adjacency,a=[];for(r in s)o=s[r],a.push(this._adjacency[r]=_.without(o,n));return a},r.prototype._rebuildIndex=function(){return this._adjacency={},this._tokens={},this._addToIndex(this.models)},r.prototype._facetMatch=function(t,e){var n,r;for(n in t)if(r=t[n],null!=r&&r!==e[n])return!1;return!0},r.prototype.typeahead=function(t,e){var n,r,o,i,u,s,a,h,p,c,l,d,f=this;if(null==this._adjacency)throw new Error("Index is not built");if(h=this._tokenize(t),a=[],p=_.keys(this._byId),c=[],n=_(h).chain().map(function(t){return t.charAt(0)}).uniq().value(),_.all(n,function(t){var e;return e=f._adjacency[t],null==e?!1:(a.push(e),(null==p||e.length<p.length)&&(p=e),!0)}),a.length<n.length)return[];for(l=0,d=p.length;d>l;l++)r=p[l],s=this.get(r),o=null==e||this._facetMatch(e,s.attributes),i=o&&_.every(a,function(t){return~_.indexOf(t,r)}),u=i&&_.every(h,function(t){return _.some(f._tokens[r],function(e){return 0===e.indexOf(t)})}),u&&c.push(s);return c},r.prototype._reset=function(){return this._tokens={},this._adjacency={},r.__super__._reset.apply(this,arguments)},r.prototype.set=function(){return r.__super__.set.apply(this,arguments),this._rebuildIndex(),this},r.prototype.remove=function(){return r.__super__.remove.apply(this,arguments),this._rebuildIndex(),this},r.prototype._onModelEvent=function(t,e){return(t==="change:"+e.idAttribute||_.indexOf(_.map(this.typeaheadAttributes,function(t){return"change:"+t}),t)>=0)&&(this._removeFromIndex(e),this._addToIndex(e)),r.__super__._onModelEvent.apply(this,arguments)},r}(Backbone.Collection)}).call(this);