(function(){var e,t,n,r,i,o,u={}.hasOwnProperty,s=function(e,t){function n(){this.constructor=e}for(var r in t)u.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},l=[].slice;n=this,r=String.prototype.trim||function(){return this.replace(/^\s+|\s+$/g,"")},i=n._,i||"undefined"==typeof require||null===require||(i=require("underscore")),e=n.Backbone,e||"undefined"==typeof require||null===require||(e=require("backbone")),t=function(e){function t(){return o=t.__super__.constructor.apply(this,arguments)}return s(t,e),t.prototype._tokenize=function(e){return null==e?null:(e=r.call(e),0===e.length?null:e.toLowerCase().split(/[\s\-_]+/))},t.prototype._tokenizeModel=function(e){if(null==this.typeaheadAttributes)throw new Error("Missing typeaheadAttributes value");return i.uniq(this._tokenize(i.flatten(i.map(this.typeaheadAttributes,function(t){return e.get(t)})).join(" ")))},t.prototype._addToIndex=function(e){var t,n,r,o,u,s,l,a,p;for(i.isArray(e)||(e=[e]),p=[],l=0,a=e.length;a>l;l++)o=e[l],s=this._tokenizeModel(o),r=null!=o.id?o.id:o.cid,this._tokens[r]=s,p.push(function(){var e,o,l,a;for(a=[],o=0,l=s.length;l>o;o++)u=s[o],n=u.charAt(0),t=(e=this._adjacency)[n]||(e[n]=[r]),~i.indexOf(t,r)?a.push(void 0):a.push(t.push(r));return a}.call(this));return p},t.prototype._removeFromIndex=function(e){var t,n,r,o,u,s,a,p;for(i.isArray(e)||(e=[e]),n=i.map(e,function(e){return null!=e.id?e.id:e.cid}),u=0,s=n.length;s>u;u++)t=n[u],delete this._tokens[t];a=this._adjacency,p=[];for(r in a)o=a[r],p.push(this._adjacency[r]=i.without.apply(i,[o].concat(l.call(n))));return p},t.prototype._rebuildIndex=function(){return this._adjacency={},this._tokens={},this._addToIndex(this.models)},t.prototype.typeaheadIndexer=function(e){return null!=e&&i.keys(e).length>0?i.map(this.where(e),function(e){return null!=e.id?e.id:e.cid}):null},t.prototype.typeahead=function(e,t){var n,r,o,u,s,l,a,p,h,d,c,_,f,y=this;if(null==this._adjacency)throw new Error("Index is not built");if(h=this._tokenize(e),p=[],d=null,o=i(h).chain().map(function(e){return e.charAt(0)}).uniq().value(),n=function(e){return e.length<((null!=d?d.length:void 0)||y.length)?d=e:void 0},i.all(o,function(e){var t;return t=y._adjacency[e],null==t?!1:(p.push(t),n(t),!0)}),p.length<o.length)return[];if(r=this.typeaheadIndexer(t),null!=r&&(p.push(r),n(r)),null==d)return this.models;if(0===d.length)return[];for(c=[],_=0,f=d.length;f>_;_++)u=d[_],s=i.every(p,function(e){return~i.indexOf(e,u)}),l=s&&i.every(h,function(e){return i.some(y._tokens[u],function(t){return 0===t.indexOf(e)})}),l&&(a=this.get(u),this.typeaheadPreserveOrder?c[this.indexOf(a)]=a:c.push(a));return this.typeaheadPreserveOrder?i.compact(c):c},t.prototype._reset=function(){return this._tokens={},this._adjacency={},t.__super__._reset.apply(this,arguments)},t.prototype.set=function(){var e;return e=t.__super__.set.apply(this,arguments),i.isArray(e)||(e=[e]),this._rebuildIndex(e),e},t.prototype.remove=function(){var e;return e=t.__super__.remove.apply(this,arguments),i.isArray(e)||(e=[e]),this._removeFromIndex(e),e},t.prototype._onModelEvent=function(e,n){var r;return r=!1,e==="change:"+n.idAttribute?(r=!0,this._removeFromIndex({id:n.previous(n.idAttribute)})):i.indexOf(i.map(this.typeaheadAttributes,function(e){return"change:"+e}),e)>=0&&(r=!0,this._removeFromIndex(n)),r&&this._addToIndex(n),t.__super__._onModelEvent.apply(this,arguments)},t}(e.Collection),e.TypeaheadCollection=t,null!=("undefined"!=typeof module&&null!==module?module.exports:void 0)&&(module.exports=t)}).call(this);