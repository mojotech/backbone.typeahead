(function(){var t=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},e={}.hasOwnProperty,n=[].slice;Backbone.TypeaheadCollection=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return t(r,e),r.prototype.tokenizeQuery=function(t){return this._tokenize(t)},r.prototype.tokenizeAttribute=function(t){return this._tokenize(t)},r.prototype._tokenize=function(t){return null==t&&(t=""),t=t.trim(),0===t.length?null:t.toLowerCase().split(/[\s\-_]+/)},r.prototype._deepObjectMap=function(t,e){return e.length>0&&_.isObject(t)?1===e.length?t[e[0]]:this._deepObjectMap(t[e[0]],e.slice(1,e.length)):t},r.prototype._getAttributeValues=function(t){return _.map(this.typeaheadAttributes,function(e){return function(n){var r;return r=n.split("."),e._deepObjectMap(t.get(r[0]),r.slice(1))}}(this))},r.prototype._extractValues=function(t){return null!=this.typeaheadAttributes?this._getAttributeValues(t):_.values(t.attributes)},r.prototype._tokenizeModel=function(t){return _.uniq(this.tokenizeAttribute(_.flatten(this._extractValues(t)).join(" ")))},r.prototype._addToIndex=function(t){var e,n,r,i,o,u,s,a,p;for(_.isArray(t)||(t=[t]),s=[],r=0,o=t.length;o>r;r++)u=t[r],p=this._tokenizeModel(u),i=null!=u.id?u.id:u.cid,this._tokens[i]=p,s.push(function(){var t,r,o,u;for(u=[],r=0,o=p.length;o>r;r++)a=p[r],n=a.charAt(0),e=(t=this._adjacency)[n]||(t[n]=[i]),~_.indexOf(e,i)?u.push(void 0):u.push(e.push(i));return u}.call(this));return s},r.prototype._removeFromIndex=function(t){var e,r,i,o,u,s,a,p;for(_.isArray(t)||(t=[t]),i=_.map(t,function(t){return null!=t.id?t.id:t.cid}),e=0,u=i.length;u>e;e++)r=i[e],delete this._tokens[r];s=this._adjacency,a=[];for(o in s)p=s[o],a.push(this._adjacency[o]=_.without.apply(_,[p].concat(n.call(i))));return a},r.prototype._rebuildIndex=function(){return this._adjacency={},this._tokens={},this._addToIndex(this.models)},r.prototype.typeaheadIndexer=function(t){return null!=t&&_.keys(t).length>0?_.map(this.where(t),function(t){return null!=t.id?t.id:t.cid}):null},r.prototype.typeahead=function(t,e){var n,r,i,o,u,s,a,p,h,l,c,d,y;if(null==this._adjacency)throw new Error("Index is not built");if(c=this.tokenizeQuery(t),l=[],d=null,i=_(c).chain().map(function(t){return t.charAt(0)}).uniq().value(),n=function(t){return function(e){return e.length<=((null!=d?d.length:void 0)||t.length)?d=e:void 0}}(this),_.all(i,function(t){return function(e){var r;return r=t._adjacency[e],null==r?!1:(l.push(r),n(r),!0)}}(this)),l.length<i.length)return[];if(r=this.typeaheadIndexer(e),null!=r&&(l.push(r),n(r)),null==d)return this.models;if(0===d.length)return[];for(y=[],o=0,h=d.length;h>o;o++)u=d[o],s=_.every(l,function(t){return~_.indexOf(t,u)}),a=s&&_.every(c,function(t){return function(e){return _.some(t._tokens[u],function(t){return 0===t.indexOf(e)})}}(this)),a&&(p=this.get(u),this.typeaheadPreserveOrder?y[this.indexOf(p)]=p:y.push(p));return this.typeaheadPreserveOrder?_.compact(y):y},r.prototype._reset=function(){return this._tokens={},this._adjacency={},r.__super__._reset.apply(this,arguments)},r.prototype.set=function(){var t;return t=r.__super__.set.apply(this,arguments),_.isArray(t)||(t=[t]),this._rebuildIndex(t),t},r.prototype.remove=function(){var t;return t=r.__super__.remove.apply(this,arguments),_.isArray(t)||(t=[t]),this._removeFromIndex(t),t},r.prototype._onModelEvent=function(t,e){var n,i;return null!=e&&(n=!1,t==="change:"+e.idAttribute?(n=!0,this._removeFromIndex({id:e.previous(e.idAttribute)})):0===t.indexOf("change:")&&(i=_.map(this.typeaheadAttributes,function(t){return"change:"+t}),(null==this.typeaheadAttributes||_.contains(i,t))&&(n=!0,this._removeFromIndex(e))),n&&this._addToIndex(e)),r.__super__._onModelEvent.apply(this,arguments)},r}(Backbone.Collection)}).call(this);